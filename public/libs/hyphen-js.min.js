/**
 * Hyphen Js - generic Angular App data layer
 * @version v0.0.63 - 2016-01-07 * @link
 * @author Blazej Grzelinski
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */var jsHyphen=angular.module("jsHyphen",[]);!function(){jsHyphen.provider("Hyphen",[function(){var a={};return a.initialize=function(){},a.$get=["$http","$q","HyphenIndexDb","ModelsAbstractFactory","BasicModel","HyphenIndexDb","$injector","$timeout",function(a,b,c,d,e,c,f,g){var h,i,j,k,l={},m=[],n=[];l.syncStartEvent=function(a){j=a},l.syncEndEvent=function(a){k=a},l.initialize=function(a){this.configuration=a,h=a,a.model.forEach(function(b){l[b.model]=new e(b,a),n.push({name:b.model,key:b.key,priority:b.priority,sync:b.sync})})},l.initializeDb=function(){i=new c(this.configuration.dbName,this.configuration.dbVersion,n),c.upgradeEvent(function(a){_(n).each(function(b){_(a.target.transaction.db.objectStoreNames).contains(b.name)?console.log("Store "+b+"already exist and will be not created again"):c.createStore(b.name,b.key)})}),c.openEvent(function(a){var b=p(n);b.then(function(a){_(n).each(function(a){c.clear(a.name)}),c.initialized=!0,r(),console.log("Load data and start app")},function(a){_(n).each(function(a){c.clear(a.name)}),console.log(a)})})},window.addEventListener("online",function(){g(function(){var a=p(n);a.then(function(a){_(n).each(function(a){c.clear(a.name)}),console.log("synchronize")},function(a){console.log(a)})},5e3)}),window.addEventListener("offline",function(){console.log("is offline")});var o,p=function(a){o=b.defer();var d=[];return _(a).each(function(a){var b=c.getStoreData(a.name,a.priority,a.sync);d.push(b)}),b.all(d).then(function(a){var b=[];_(a).each(function(a){var c;try{c=f.get(a.model)}catch(d){c=f.get("DefaultModel")}if(!c.syncNew)throw Error("Not defined synchronise method for 'syncNew' for model "+a.model);if(!c.syncUpdated)throw Error("Not defined synchronise method for 'syncUpdated' for model "+a.model);if(!c.syncDeleted)throw Error("Not defined synchronise method for 'syncDeleted' for model "+a.model);var e=[],g=[],h=[];_(a.data).each(function(a){j&&j(),"new"==a.action&&e.push(a),"updated"==a.action&&g.push(a),"deleted"==a.action&&h.push(a)}),a.sync&&b.push({name:a.model,syncNew:c.syncNew,syncUpdated:c.syncUpdated,syncDeleted:c.syncDeleted,newData:e,updateData:g,deleteData:h,priority:a.priority})}),b=_(b).sortBy(function(a){return a.priority}),q(b)},function(a){console.log("cannot read from db")}),o.promise},q=function(a){var c=a[0];if(c){var d=c.syncNew(c.newData),e=c.syncUpdated(c.updateData),f=c.syncDeleted(c.deleteData);b.all([d,e,f]).then(function(){a.shift(),q(a)},function(a){k(a),o.reject(a)})}else k&&k(),o.resolve()},r=function(){_(m).each(function(a){var b=a.method,c=a.params;b.data=a.data,b.call(c).then(function(a){self.defer.resolve(a)},function(a){self.defer.reject(a)})})};return l.enqueue=function(a){return navigator.onLine?(m=a,self.defer=b.defer(),c.initialized&&r()):(console.error("app is offline"),self.defer.resolve("app is offline")),self.defer.promise},l}],a}]),jsHyphen.factory("HyphenDataStore",["HyphenDataModel",function(a){var b=function(c,d){b.prototype.stores[c]=new a(d,c)};return b.prototype.stores={},b.actions={},b.actions["delete"]=function(a,c,d){b.prototype.stores[c].removeDataOnline(a)},b.actions.save=function(a,c,d){b.prototype.stores[c].addData(a)},b.actions.custom=function(a,c,d){d.responseHandler(a,b.actions)},b.saveResult=function(a,c,d){0!=d.processResponse&&(d.responseHandler?d.responseHandler(a,b.prototype.stores):"delete"==d.method||"delete"==d.action?b.prototype.stores[c].remove(a):b.prototype.stores[c].add(a))},b.getStores=function(){return b.prototype.stores},b}]),jsHyphen.factory("DefaultModel",["$q","$timeout",function(a,b){var c=function(a){};return c.key="_id",c.indexes=[{name:"Id",key:"id"},{name:"_Id",key:"_id"}],c.synchronize=function(){var c=a.defer();return b(function(){c.resolve("data resolvedd")},100),c.promise},c}]),jsHyphen.factory("BasicModel",["ApiCallFactory","HyphenDataStore","$injector","HyphenSynchronizer","$q",function(a,b,c,d,e){var f=[],g=function(d,f){this.entityModel=null;try{this.entityModel=c.get(d.model)}catch(g){this.entityModel=c.get("DefaultModel")}var h=new b(d.model,this.entityModel);this.dataModel=h.stores[d.model],this.api={};var i=new a,j=[];_(d.rest).each(function(a){var c=this,g=i.createApiCall(a,f,d.model);this.api[a.name]={},c.api[a.name].loading=!1,this.api[a.name].call=function(f){var h=e.defer(),i=Array.prototype.slice.call(arguments);if(navigator.onLine)if(a["invoked"+i.join("")])h.resolve([]);else{g.dataSet=c.api[a.name].data;var k=g.invoke.call(g,f);c.api[a.name].loading=!0,k.then(function(e){c.api[a.name].loading=!1,b.saveResult(e.data,d.model,a),h.resolve(e)},function(b){c.api[a.name].loading=!1,h.reject(b)})}else{if(!c.entityModel[a.name+"Offline"])throw new Error("No offline method: "+d.model+"."+a.name+"Offline");try{c.entityModel[a.name+"Offline"](f,c.api[a.name].data,b.prototype.stores),h.resolve(c.api[a.name].data)}catch(l){console.warn(l),h.reject("can not save data in offline"+l)}}if(a.cache&&"get"!=a.method)throw new Error("Cache option can be switch on only for get parameters");return a.cache&&"get"==a.method&&(a["invoked"+i.join("")]=!0),j.push(k),e.all(j),h.promise}},this)};return g.getPromises=function(){return f},g}]),jsHyphen.factory("ModelsAbstractFactory",[function(){var a=function(){this.types={}};return a.prototype.registerModel=function(a,b){b.prototype;this.types[a]=b},a.prototype.getModel=function(a,b){var c=this.types[a.model];return c?new c(a,b):null},a}]),jsHyphen.factory("ApiCallFactory",["HyphenPost","HyphenGet","HyphenPut","HyphenDelete",function(a,b,c,d){var e=function(){};return e.prototype.callType=b,e.prototype.createApiCall=function(e,f,g){switch(e.method){case"get":this.callType=b;break;case"post":this.callType=a;break;case"put":this.callType=c;break;case"delete":this.callType=d}return new this.callType(e,f,g)},e}])}(),jsHyphen.factory("IndexedDbCommandBase",["$q",function(){var a=function(a,b){var c=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,this),d=window.indexedDB.open(a,b);d.onsuccess=function(a){c.db=a.target.result,c.stores=a.target.result.objectStoreNames,c.openEvent&&c.openEvent(a),console.log("Local db initialized")},d.onerror=function(a){console.log(a)},d.onupgradeneeded=function(a){c.db=a.target.result,c.upgradeEvent&&c.upgradeEvent(a)},d.oncomplete=function(a){console.log(a)}};return a.prototype.isInitialized=function(a){return this.db?!0:!1},a.prototype.registerPromise=function(a){var b=new Promise(function(b,c){a.onsuccess=function(a){b({data:a})},a.onerror=function(a){c(a)},a.onupgradeneeded=function(a){b({data:a})},a.oncomplete=function(a){b({data:a})}});return b},a}]),jsHyphen.factory("IndexedDbCommands",["$q","IndexedDbCommandBase",function(a,b){var c=function(a,c,d){b.call(this,a,c)};return c.prototype=Object.create(b.prototype),c.prototype.openDataBase=function(a){},c.prototype.closeDb=function(){this.db&&this.db.close()},c.prototype.clearStores=function(a,b){var c,d,e=this;return b.length>0?(Object.keys(a).forEach(function(b){d=e.db.deleteObjectStore(a[b].name)}),c=new Promise(function(a,b){d.onsuccess=function(b){a({data:b})},d.onerror=function(a){b(a)},d.onupgradeneeded=function(b){a({data:b})},d.oncomplete=function(b){a({data:b})}})):c=new Promise(function(a,b){a()}),c},c.prototype.createStore=function(a,b){var c=this.db.createObjectStore(a,{autoIncrement:!1,keyPath:b});return c},c.prototype.clear=function(a){var b=this.db.transaction(a,"readwrite"),c=b.objectStore(a),d=c.clear();return this.registerPromise(d)},c.prototype.clearSynchronized=function(b){var c=this.db.transaction(b,"readwrite"),d=c.objectStore(b),e=d.openCursor();a.defer();e.onsuccess=function(a){var b=a.target.result;b&&(b.value.action&&d["delete"](b.value),b["continue"]())}},c.prototype.createStores=function(a){var b,c;for(var d in a)c=this.db.createObjectStore(a[d].name,{autoIncrement:!1,keyPath:a[d].key});return b=new Promise(function(a,b){c.onsuccess=function(b){a({data:b})},c.onerror=function(a){b(a)},c.onupgradeneeded=function(b){a({data:b})},c.oncomplete=function(b){a({data:b})}})},c.prototype.addRecord=function(a,b){var c=this.db.transaction(b,"readwrite"),d=c.objectStore(b);d.add(a)},c.prototype.addOrUpdateRecord=function(a,b,c){var d=this,e=this.db.transaction(b,"readwrite"),f=e.objectStore(b),g=f.get(a._id);g.onerror=function(b){console.log("can not retrive record "+a)},g.onsuccess=function(e){g.result?d.updateRecord(a,b,c):d.addRecord(a,b)}},c.prototype.updateRecord=function(a,b,c){var d=this.db.transaction(b,"readwrite").objectStore(b),e=d.get(c);e.onsuccess=function(b){d.put(a)}},c.prototype.deleteRecord=function(a,b){var c=this.db.transaction(a,"readwrite").objectStore(a),d=c["delete"](b);d.onsuccess=function(a){}},c.prototype.removeData=function(){},c.prototype.getStoreData=function(b,c,d){var e=this.db.transaction(b,"readwrite"),f=e.objectStore(b),g=f.openCursor(),h=[],i=a.defer();return g.onsuccess=function(a){var e=a.target.result;e?(h.push(e.value),e["continue"]()):i.resolve({model:b,data:h,priority:c,sync:d})},g.onerror=function(a){i.resolve(a)},i.promise},c}]),jsHyphen.factory("HyphenIndexDb",["IndexedDbCommands",function(a){var b,c=function(c,d,e){b=new a(c,d,e)};return c.openDb=function(a){return b.openDataBase(a)},c.clearStores=function(a,c){return b.clearStores(a,c)},c.getStoreData=function(a,c,d){return b.getStoreData(a,c,d)},c.createStores=function(a){return b.createStores(a)},c.close=function(){return b.closeDb()},c.addRecordToStore=function(a,c){return b.addRecord(a,c)},c.updateRecordStore=function(a,c,d){return b.updateRecord(a,c,d)},c.deleteRecord=function(a,c){return b.deleteRecord(a,c)},c.upgradeEvent=function(a){return b.upgradeEvent=a},c.openEvent=function(a){return b.openEvent=a},c.createStore=function(a,c){return b.createStore(a,c)},c.clear=function(a){return b.clear(a)},c.getStores=function(){return b.stores},c.clearSynchronized=function(a){return b.clearSynchronized(a)},c.addOrUpdateRecord=function(a,c,d){return b.addOrUpdateRecord(a,c,d)},c.isInitialized=function(){return b.isInitialized()},c}]),jsHyphen.factory("HyphenDataModel",["HyphenIndexDb",function(a){var b=function(a,b){this.model=a,this.modelName=b,this.data=[];var c=this;_(a.indexes).each(function(a){c["getBy"+a.name]=function(b){return c["index"+a.name]||(c["index"+a.name]=_(c.getData()).indexBy(function(b){return b[a.key]})),c["index"+a.name][b]}})};b.prototype.data=[];var c=function(){var a=this;_(this.model.indexes).each(function(b){a["index"+b.name]=null})};return b.prototype.getData=function(){return _(this.data).filter(function(a){return"deleted"!=a.action})},b.prototype.where=function(a){return _(this.data).filter(function(b){return b[a.prop]==a.value})},b.prototype.remove=function(b){var d=this,e=this.model.key,b=Array.isArray(b)?b:[b];_(b).each(function(b){if(navigator.onLine){var c=b&&b[e]?b[e]:b;this.data=_(this.data).filter(function(a){return a[e]!=c})}else{"new"==b.action?a.deleteRecord(d.modelName,b[e]):(b.action="deleted",a.addOrUpdateRecord(b,d.modelName,b[e]));var c=b&&b[e]?b[e]:b;this.data=_(this.data).filter(function(a){return a[e]!=c})}},this),c.call(this)},b.prototype.add=function(b){var d=this;b=JSON.parse(JSON.stringify(b));var e=this.model.key,b=Array.isArray(b)?b:[b];_(b).each(function(b){var c;if(!b[e])throw new Error("Key is not defined for '"+d.modelName+"', record cannot be added. Record"+b);var f=_(d.data).find(function(a,d){return c=d,a[e]==b[e]});f?(navigator.onLine||"new"!=b.action&&(b.action="updated"),d.data[c]=_.extend(new d.model(b),b),navigator.onLine||a.updateRecordStore(b,d.modelName,b[e])):(navigator.onLine||(b.action="new"),b=_.extend(new d.model(b),b),d.data.push(b),navigator.onLine||a.addRecordToStore(b,d.modelName))}),c.call(this)},b}]),jsHyphen.factory("HyphenCallBase",["$http",function(a){var b=function(b,c){this.httpOptions=b,this.hyphenConfiguration=c,this.$http=a,this.config={}};b.prototype.urlParser=function(a,b){var b=Array.isArray(b)?b:[b],c=a.split("/"),d=0;return _(c).each(function(a,e){-1!=a.indexOf(":")&&(c[e]=b[d],d++)}),c.join("/")};var c=function(a,b){return a.match(b+"$")==b};return b.prototype.invoke=function(a){return c(this.hyphenConfiguration.baseUrl,"/")&&(this.hyphenConfiguration.baseUrl=this.hyphenConfiguration.baseUrl.substring(0,this.hyphenConfiguration.baseUrl.length-1)),this.config.url=this.hyphenConfiguration.baseUrl+"/"+this.urlParser(this.httpOptions.url,a),this.config.data=this.dataSet,this.hyphenConfiguration.requestInterceptor&&(this.config=this.hyphenConfiguration.requestInterceptor(this.config)),this.$http(this.config)},b}]),jsHyphen.factory("HyphenGet",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="GET"};return b.prototype=Object.create(a.prototype),b}]),jsHyphen.factory("HyphenPost",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="POST"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenPut",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="PUT"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenDelete",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="DELETE"};return b.prototype=Object.create(a.prototype),b}]),jsHyphen.factory("HyphenSynchronizer",["HyphenIndexDb","HyphenDataStore",function(a,b){var c={};return c.checkIndexDb=function(){var c=b.getStores();_(c).each(function(b){a.getStoreData(b)})},c}]);